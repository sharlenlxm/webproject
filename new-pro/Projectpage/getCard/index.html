<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>领取会员卡</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<link rel="stylesheet" type="text/css" href="./css/reset.css" media="all" />
		<link rel="stylesheet" type="text/css" href="./css/sweetalert.css" media="all" />
		<link rel="stylesheet" type="text/css" href="./css/style.css" media="all">
	</head>
	<body>
		<div id="loadstart" class="loadzz">
			<div class="loading_k">
				<div class="loading"></div>
			</div>
		</div>
		<div class="getCardB" id="getCardB">
			<div class="cardB" v-cloak>
				<div class="cardB_lt">
					<img :src="setCard.logoUrl" class="cardB_lt_img">
					<div class="cardB_lt_name">
						<h3>{{setCard.cardName}}</h3>
						<p>{{subtitle}}</p>
					</div>
				</div>
				<div class="cardB_ld">
					<p>8888 8888 8888 8888</p>
				</div>
				<div class="cardB_rt">
					<img src="./img/erweima-2@2x.png">
				</div>
				<img :src="setCard.localImgUrl" class="cardBbg">
			</div>
			<div class="cardBtn" v-on:click="takeCard()" v-cloak>
				立即领取
			</div>
			<div class="detaili shareD" v-cloak>
				<label>分享说明</label>
				<p>{{shareDescribe}}</p>
			</div>
			<ul class="cardDul" v-cloak>
				<div class="cardDulTit">[会员卡详情]</div>
				<li>
					<div class="detaili">
						<label>特权说明</label>
						<p>{{setCard.privilegeState}}</p>
					</div>
				</li>
				<li>
					<div class="detaili">
						<label>使用须知</label>
						<p>{{setCard.useInstructions}}</p>
					</div>
				</li>
			</ul>
			<ul class="cardDul cardDulmd" v-cloak>
				<div class="cardDulTit">[适用门店]</div>
				<li v-for="item in store">
					<div class="detaili">
						<label>门店名称</label>
						<p>{{item.split('||')[1]}}</p>
					</div>
				</li>
			</ul>
		</div>
	</body>
	<script src="./js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="./js/sweetalert.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="./js/vue.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="./common/config.js"></script>
	<script src="./common/utility.js"></script>
	<script>
		
		function getQueryString(name) {
		    var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
		    var r = decodeURIComponent(window.location.search).substr(1).match(reg);
		    if (r != null) {
		        return unescape(r[2]);
		    }
		    return null;
		}
		
		var _w = $(window).width()
		var _h = (_w - 60) / 1.68449197
		$('.cardB').width(_w - 60)
		$('.cardB').height(_h)

		var merNumber, cardCon, applystore, subtitle, wxCardNo, showQrcodeUrl, shareDescribeText
		var deliveryNo = getQueryString('deliveryNo')
		var insNumber = getQueryString('institutionNumber')
		var tit = true

		// 查询渠道详情
		getdeliveryCon()
		//设置页面内容
		setTimeout(function() {
			setCardf()
		}, 500);

		function getdeliveryCon() {
			$.ajax({
				type: "get",
				url: CmsConfig.ServiceUrl.ApiRootUrlMeb + CmsConfig.addressUrl.Mervip.getChannelDetails,
				data: {
					"deliveryNo": deliveryNo
				},
				async: true,
				dataType: "json",
				headers: {
					"Content-Type": "application/json"
				},
				success: function(data) {
					if (data.code === 1000) {
						applystore = data.data.shopNumbers
						merNumber = data.data.merchantNumber
						getshareCon(data.data.merchantNumber)
						getCardCon(data.data.merchantNumber)
						getCardWxCon(data.data.merchantNumber)
					} else {
						console.log(data.msg)
						swal({
							title: "",
							text: data.msg,
							type: "error",
							showCancelButton: false,
							closeOnConfirm: false,
							showConfirmButton: false,
						});
					}
				}
			});
		}

		function getshareCon(merNum) {
			$.ajax({
				type: "get",
				url: CmsConfig.ServiceUrl.ApiRootUrlMeb + CmsConfig.addressUrl.Mervip.getPoster,
				data: {
					"merchantNumber": merNum
				},
				async: true,
				dataType: "json",
				headers: {
					"Content-Type": "application/json"
				},
				success: function(data) {
					if (data.code === 1000) {
						if (data.data.posterEnabled == 0) {
							shareDescribeText = data.data.posterShareExplain
							$('title').html(data.data.posterTitle)
							$('.cardBtn').css('border-radius', data.data.posButtRadius + 'px')
							$('.cardBtn').css('opacity', data.data.posButtOpacity / 100)
							$('.cardBtn').css('background', data.data.posButtcolor)
							$('.cardBtn').css('color', data.data.posButtTextColor)
							$('body').css('background-color', data.data.posterColor)
							$('body').css('background-image', 'url(' + data.data.posterImgUrl + ')')
							tit = false
						}
					} else if (data.code === -2) {
						console.log(data.msg)
						tit = true
					} else {
						console.log(data.msg)
						swal({
							title: "",
							text: data.msg,
							type: "error",
							showCancelButton: false,
							closeOnConfirm: false,
							showConfirmButton: false,
						});
					}
				}
			});
		}

		function getCardCon(merNum) {
			$.ajax({
				type: "get",
				url: CmsConfig.ServiceUrl.ApiRootUrlMeb + CmsConfig.addressUrl.Mervip.getCard,
				data: {
					"merchantNumber": merNum
				},
				async: true,
				dataType: "json",
				headers: {
					"Content-Type": "application/json"
				},
				success: function(data) {
					if (data.code === 1000) {
						cardCon = data.data
						if (tit) {
							shareDescribeText = data.data.shareDescribe
							$('title').html(data.data.shareTitle)
						}
					} else {
						console.log(data.msg)
						swal({
							title: "",
							text: data.msg,
							type: "error",
							showCancelButton: false,
							closeOnConfirm: false,
							showConfirmButton: false,
						});
					}
				}
			});
		}

		function getCardWxCon(merNum) {
			$.ajax({
				type: "get",
				url: CmsConfig.ServiceUrl.ApiRootUrlMeb + CmsConfig.addressUrl.Mervip.getWCard,
				data: {
					"merchantNumber": merNum
				},
				async: true,
				dataType: "json",
				headers: {
					"Content-Type": "application/json"
				},
				success: function(data) {
					if (data.code === 1000) {
						wxCardNo = data.data.wxCardNo
						subtitle = data.data.subtitle
					} else {
						console.log(data.msg)
						swal({
							title: "",
							text: data.msg,
							type: "error",
							showCancelButton: false,
							closeOnConfirm: false,
							showConfirmButton: false,
						});
					}
				}
			});
		}

		function getshareCard() {
			console.log(merNumber, cardCon, applystore, subtitle, wxCardNo, showQrcodeUrl)
			$.ajax({
				type: "get",
				url: CmsConfig.ServiceUrl.ApiRootUrlMeb + CmsConfig.addressUrl.Card.shareCard,
				data: {
					"merchantNumber": merNumber,
					"cardNo": merNumber,
					"wxCardId": wxCardNo,
					"institutionNumber": insNumber,
					"deliveryNo": deliveryNo,
				},
				async: true,
				dataType: "json",
				headers: {
					"Content-Type": "application/json"
				},
				success: function(data) {
					if (data.code === 1000) {
						window.location.href = data.data.showQrcodeUrl
					} else {
						console.log(data.msg, 1111)
						swal({
							title: "",
							text: data.msg,
							type: "error",
							showCancelButton: false,
							closeOnConfirm: false,
							showConfirmButton: false,
						});
					}
				}
			});
		}

		function setCardf() {
			new Vue({
				el: '#getCardB',
				data: {
					shareDescribe: shareDescribeText,
					setCard: cardCon,
					store: applystore,
					subtitle: subtitle,
				},
				methods: {
					takeCard: function() {
						getshareCard()
					}
				},
				mounted() {
					$('#loadstart').hide()
				}
			})
		}
	</script>
</html>
