<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="../../public/css/xadmin.css">
    <script type="text/javascript" src="../../public/js/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="../../public/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../public/js/xadmin.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
     .layui-input-inline {
        width: 480px !important;
    }
    .layui-form-label{
        width: 150px;
    }
    </style>
</head>

<body id="iosiframe">
    <div class="x-body">
        <div class="layui-row">
            <form class="layui-form" action="" lay-filter="cardAdd">
                <div class="layui-form-item">
                    <label class="layui-form-label">商户名称</label>
                    <div class="layui-input-inline" style="margin-bottom:15px">
                        <input type="text" name="merchantNumber" autocomplete="off" placeholder="请搜索并选择商户" class="layui-input" lay-verify="merchantNumber" id="search" onblur="bl()" onfocus="fc()">
                        <div class="layui-input-inline" style="position:absolute;top:34px;left:0;z-index:500;max-height:190px;overflow:auto;background-color:#fff" id="searchBox">
                        </div>
                    </div>
                    <div id="noali" style="display:none">
                    <div class="layui-form-item">
                        <label class="layui-form-label">商户类型</label>
                        <div class="layui-input-block widthauto">
                            <input type="radio" name="merchantType" value="个人" title="个人" lay-filter="cardvalid" checked="">
                            <input type="radio" name="merchantType" value="个体" title="个体" lay-filter="cardvalid">
                            <input type="radio" name="merchantType" value="企业" title="企业" lay-filter="cardvalid">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">子商户号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="newSubaccountNumber" autocomplete="off" placeholder="子商户号" class="layui-input" lay-verify="subaccountNumber">
                        </div>
                    </div>
                    
                    <div class="layui-form-item xdl">
                        <label class="layui-form-label">子商户秘钥</label>
                        <div class="layui-input-inline">
                            <input type="text" name="subaccountKey" autocomplete="off" placeholder="商户秘钥" class="layui-input" lay-verify="subaccountKey">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">结算标识</label>
                        <div class="layui-input-block widthauto">
                            <input type="radio" name="acntType" value="对私" title="对私" lay-filter="cardvalid" checked="">
                            <input type="radio" name="acntType" value="对公" title="对公" lay-filter="cardvalid">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">结算类型</label>
                        <div class="layui-input-inline" id="jiesuan">
                          
                        </div>
                    </div>
                    <div class="layui-form-item isAli" style="display:none">
                        <label class="layui-form-label">支付宝费率(%)</label>
                        <div class="layui-input-inline">
                            <input type="text" name="alipayRate" autocomplete="off" placeholder="支付宝费率" class="layui-input" lay-verify="alipayRate">
                        </div>
                    </div>
                     <div class="layui-form-item isWechat" style="display:none">
                        <label class="layui-form-label">微信费率(%)</label>
                        <div class="layui-input-inline">
                            <input type="text" name="weChatRate" autocomplete="off" placeholder="微信费率" class="layui-input" lay-verify="weChatRate">
                        </div>
                    </div>
                     <div class="layui-form-item isJian" style="display:none">
                        <label class="layui-form-label">京东支付费率(%)</label>
                        <div class="layui-input-inline">
                            <input type="text" name="jingdongRate" autocomplete="off" placeholder="京东支付费率" class="layui-input" lay-verify="jingdongRate">
                        </div>
                    </div>
                    <div class="layui-form-item isJian"  style="display:none">
                        <label class="layui-form-label">是否开通云闪付</label>
                        <div class="layui-input-inline">
                          <input type="radio"  lay-filter="isYun" name="isOpenYunPay" value="1" title="否" checked="">
                          <input type="radio"  lay-filter="isYun" name="isOpenYunPay" value="0" title="是">
                        </div>
                    </div>
                    <div class="layui-form-item isYun" style="display:none">
                        <label class="layui-form-label">云闪付支付费率1(%)</label>
                        <div class="layui-input-inline">
                            <input type="text" name="unionPayRate" autocomplete="off" placeholder="单笔1000以内包括1000" class="layui-input" lay-verify="unionPayRate">
                        </div>
                    </div>
                    <div class="layui-form-item isYun"  style="display:none">
                        <label class="layui-form-label">云闪付支付费率2(%)</label>
                        <div class="layui-input-inline">
                            <input type="text" name="unionPayRate2" autocomplete="off" placeholder="单笔1000以上" class="layui-input" lay-verify="unionPayRate2">
                        </div>
                    </div>
                    
                    <div class="layui-form-item " id="sxf" style="display:none">
                        <label class="layui-form-label">任务单号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="sxfTask" autocomplete="off" placeholder="任务单号(仅随行付通道需要)" class="layui-input" lay-verify="sxfTask">
                        </div>
                    </div>
                     <div class="layui-form-item xdl">
                        <label class="layui-form-label">终端号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="terminalNumber" autocomplete="off" placeholder="终端号" class="layui-input" lay-verify="terminalNumber">
                        </div>
                    </div>
                    <div class="layui-form-item xdl">
                        <label class="layui-form-label">门店号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="stoeId" autocomplete="off" placeholder="门店号" class="layui-input" lay-verify="terminalNumber">
                        </div>
                    </div>
                    <!-- <div class="layui-form-item">
                        <label class="layui-form-label">费率</label>
                        <div class="layui-input-inline">
                            <input type="text" name="rate" autocomplete="off" placeholder="费率" class="layui-input" lay-verify="terminalNumber">
                        </div>
                    </div> -->
                   
                    
                   
                <div class="layui-form-item">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-inline">
                        <div class="layui-input-inline">
                            <input class="layui-checkbox" type="checkbox" name="disable" lay-skin="switch" lay-filter="disable" lay-text="开|关" checked>
                        </div>
                    </div>
                </div>
                    <div id="ali" style="display:none">
                        <div class="layui-form-item">
                            <label class="layui-form-label">请扫码获取授权</label>
                            <div class="layui-input-inline">
                                <div id="qrcode"></div>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="layui-form-item">
                        <label class="layui-form-label">成本费率模式</label>
                        <div class="layui-input-inline widthauto">
                            <input type="radio" name="Costratemodel" value="0" title="继承通道" checked="">
                            <input type="radio" name="Costratemodel" value="1" title="自定义">
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" name="disCount" autocomplete="off" placeholder="自定义成本费率" class="layui-input">
                        </div>
                    </div> -->
                    <div class="layui-form-item layui-layout-admin">
                        <div class="layui-input-block">
                            <div class="layui-footer" style="left: 0;text-align: center;">
                                <button class="layui-btn" lay-submit="" lay-filter="add">立即提交</button>
                                <button type="reset" class="layui-btn layui-btn-primary" id="quxiao">取消</button>
                            </div>
                            <!--<i class="layui-icon" lay-tips="推荐追求开发效率和缺乏前端开发经验的使用，后端开发者的最爱。">123123123</i>-->
                        </div>
                    </div>
            </form>
        </div>
    </div>
    <script src="../../common/config-organ.js"></script>
    <script src="../../common/utility.js"></script>
    <script src="../../public/js/qrcode.min.js"></script>
    <script>
    var qrcode = new QRCode('qrcode', {
        text: '',
        width: 256,
        height: 256,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
    });
    function isbaifenbi(data){
        if(data.indexOf('%') >= 0 ){
                return (parseFloat(data.replace('%','')) /10000 *100 ).toFixed(4)
            }else{
                return  (parseFloat(data) /10000 *100 ).toFixed(4)
            }
    }
    var userNumber = JSON.parse(sessionStorage.getItem('organUser')).institutionNumber;
    var index = parent.layer.getFrameIndex(window.name);
    $('#quxiao').click(function() {

        setTimeout(function() { parent.layer.close(index) }, 16);
    })

    function clickS(e) {
        $('#search').val(e.getAttribute('data-id'))
        console.log(e)
        $('#search').attr('shopNumber', e.getAttribute('data-name'))
        document.getElementById('searchBox').innerHTML = ''
    }

    function bl() {
        setTimeout(function() {
            $('#searchBox').hide()
        }, 200)
        //$('#searchBox').hide()
    }

    function fc() {
        $('#searchBox').show()
        CmsUtility.postAjaxCall(
            //系统设置
            CmsConfig.addressUrl.Mechanism.getMerchantNumberlist, {
                "merchantName": $('#search').val(),
                "institutionNumber": userNumber,
                "page": 1,
                "limit": 100
            },
            function(data) {
                console.log(this.value)
                if (data.code == 1000) {
                    var str = ''
                    for (var i = 0; i < data.data.merchantNumberlist.length; i++) {
                        str += '<div class="layui-btn layui-btn-primary" data-id="' + data.data.merchantNumberlist[i].merchantName + '" data-name="' + data.data.merchantNumberlist[i].merchantNumber + '" style="width:100%;margin-left:0" onclick="clickS(this)" >' + '[' + data.data.merchantNumberlist[i].merchantNumber + ']' + data.data.merchantNumberlist[i].merchantName + '</div>'
                    }
                    document.getElementById('searchBox').innerHTML = str
                    // layer.msg('保存成功')
                    // setTimeout(function(){
                    //  x_admin_close()
                    // },500);

                } else {
                    layer.msg(data.msg)

                }
            },
            function(data) {
                console.log('222')
            }
        )

    }

    function subPage(data, data1) {
        console.log(data, data1)
        // if(data1 == )
        var jgData = data
        var serverUrl = window.parent.serverUrl

        if (jgData.payment == 4) {
            $('.xdl').show()
        }
        if (jgData.payment == 5) {
            $('#sxf').show()
        }
        if (jgData.payment == 0) {
            CmsUtility.postAjaxCall(
                //系统设置
                CmsConfig.addressUrl.Mechanism.getZFBOfficial, {
                    'alipayNumber': jgData.channel,
                    "institutionNumber": userNumber
                },
                function(data) {
                    if (data.code == 1000) {
                        console.log(data)
                        sjData = data.data[0]
                        var jumphref = 'https://api.51shanhe.com/h5-pay/alioauth/oauth.html?institutionNumber=' + userNumber + '&merchantNumber=' + jgData.merchantNumber + '&paymentChannel=' + jgData.channel
                        qrcode.clear();
                        qrcode.makeCode('https://openauth.alipay.com/oauth2/appToAppAuth.htm?app_id=' + sjData.alipayAppid + '&redirect_uri=' + jumphref);


                        $('#ali').show()

                    } else {
                        layer.msg(data.msg)

                    }
                },
                function(data) {
                    console.log('222')
                },
                'post',
                'false'
            )
        } else {
            $('#ali').hide()
            $('#noali').show()
        }

            
        // if(jgData.payment == 2){
        //              $('#disanfang').show()
        // }
        layui.use(['laydate', 'table', 'upload', 'form'], function() {
            var $ = layui.jquery,
                upload = layui.upload,
                laydate = layui.laydate,
                table = layui.table,
                form = layui.form,
                admin = layui.admin,
                element = layui.element,
                layer = layui.layer;
            var tableSelect = layui.tableSelect;
            if(jgData.payment != 4){
                $('.xdl').hide()
            }
            
            if(jgData.payment == 5){
                $('#sxf').show()
            }
            if(jgData.payment == 1 || jgData.payment == 2){
                $('#jiesuan').html('<input type="radio" name="rateType" value="T1" title="T1" checked="">')
               
            }else{
                $('#jiesuan').html('<input type="radio" name="rateType" value="T1" title="T1" checked=""><input type="radio" name="rateType" value="D1" title="D1"><input type="radio" name="rateType" value="D0" title="D0">')
                 $('.isAli').show()
                 $('.isWechat').show()
                 $('.isJian').show()
            }
            if(jgData.payment == 1){
                $('.isWechat').show()
            }
             form.render()
            $("#search").bind('input propertychange', function() {
                console.log(this.value)
                $('#search').removeAttr('shopNumber')
                document.getElementById('searchBox').innerHTML = ''
                CmsUtility.postAjaxCall(
                    //系统设置
                    CmsConfig.addressUrl.Mechanism.getMerchantNumberlist, {
                        "merchantName": this.value,
                        "institutionNumber": userNumber,
                        "page": 1,
                        "limit": 100
                    },
                    function(data) {
                        console.log(this.value)
                        if (data.code == 1000) {
                            var str = ''
                            for (var i = 0; i < data.data.merchantNumberlist.length; i++) {
                                str += '<div class="layui-btn layui-btn-primary" data-id="' + data.data.merchantNumberlist[i].merchantName + '" data-name="' + data.data.merchantNumberlist[i].merchantNumber + '" style="width:100%;margin-left:0" onclick="clickS(this)" >' + '[' + data.data.merchantNumberlist[i].merchantNumber + ']' + data.data.merchantNumberlist[i].merchantName + '</div>'
                            }
                            document.getElementById('searchBox').innerHTML = str
                            // layer.msg('保存成功')
                            // setTimeout(function(){
                            //  x_admin_close()
                            // },500);

                        } else {
                            layer.msg(data.msg)

                        }
                    },
                    function(data) {
                        console.log('222')
                    }
                )
            })
            //表单初始赋值
            var shopName = jgData.merchantName
            $('#search').attr('shopNumber', jgData.merchantNumber)
            form.val('cardAdd', {
                "merchantNumber": shopName,
                "newSubaccountNumber": jgData.subaccountNumber,
                "subaccountKey": jgData.subaccountKey,
                "merchantType":jgData.merchantType,
                "acntType": jgData.acntType,
                "rateType": jgData.rateType,
                "alipayRate": (jgData.alipayRate * 100).toFixed(2),
                "weChatRate": (jgData.weChatRate * 100).toFixed(2),
                "jingdongRate": (jgData.jingdongRate * 100).toFixed(2),
                "isOpenYunPay": jgData.isOpenYunPay,
                "unionPayRate": (jgData.unionPayRate * 100).toFixed(2),
                "unionPayRate2": (jgData.unionPayRate2 * 100).toFixed(2),
                "subsidyType": jgData.subsidy,
                "rateType": jgData.rateType,
                "sxfTask": jgData.sxfTask,
                "terminalNumber":jgData.terminalNumber,
                "stoeId":jgData.stoeId,
            })

            form.on('switch(riskMode)', function(data) { //消费优惠开关
                // layer.tips('继承状态：' + (this.checked ? '已开启' : '已关闭'), data.othis)
                riskMode = this.checked

            });
            form.on('switch(disable)', function(data) { //充值优惠开关
                // layer.tips('充值优惠：' + (this.checked ? '已开启' : '已关闭'), data.othis)
                disable = this.checked
            });
            form.on('radio(isYun)', function(data) { //消费优惠开关
            // layer.tips('继承状态：' + (this.checked ? '已开启' : '已关闭'), data.othis)
            if(this.value == 0){
                $('.isYun').show()
            }else{
                $('.isYun').hide()
            }

        });

            /*---------- 自定义验证规则 ----------*/
            /*---------- 自定义验证规则 ----------*/
            form.verify({
                merchantNumber: function(value) {
                    if (value.length == "" || $('#search').attr('shopNumber') == undefined) {
                        return '请搜索并选择商户'
                    }

                },
                subaccountNumber: function(value) {
                    if (value.length == "") {
                        return '子商户编号不得为空';
                    }
                },
                // subaccountKey: function(value) {
                //  if(value.length == "") {
                //      return '商户秘钥不能为空！';
                //  }
                // },
                // wechatAppid: function(value) {
                //  if(value.length == "") {
                //      return '微信公众号appID不能为空！';
                //  }
                // },
                // smallroutineAppid: function(value) {
                //  if(value.length == "") {
                //      return '小程序appID不能为空！';
                //  }
                // },
                // appsecret: function(value) {
                //  if(value.length == "") {
                //      return 'appsecret不能为空！';
                //  }
                // },
                // terminalNumber: function(value) {
                //  if(value.length == "") {
                //      return '终端号不能为空！';
                //  }
                // },
            });


            /*---------- 监听提交 ----------*/
            form.on('submit(add)', function(data, index) {
                var tjData = data.field;

                tjData.institutionNumber = userNumber
                tjData.subaccountNumber = jgData.subaccountNumber
                tjData.paymentChannel = jgData.channel
                tjData.merchantNumber = $('#search').attr('shopNumber')
                tjData.deletionFlag = 0
                tjData.channelType = jgData.payment
                console.log(tjData)
                tjData.alipayRate = isbaifenbi(tjData.alipayRate)
                tjData.disable = tjData.disable == 'on'?'0':'1'
            tjData.weChatRate = isbaifenbi(tjData.weChatRate)
            tjData.jingdongRate = isbaifenbi(tjData.jingdongRate)
            if(tjData.isOpenYunPay == 0){
                 tjData.unionPayRate = isbaifenbi(tjData.unionPayRate)
                tjData.unionPayRate2 = isbaifenbi(tjData.unionPayRate2)
            }
            tjData.subsidyType = 1
                var index = layer.load(2, { shade: [0.4, '#393D49'] })
                CmsUtility.postAjaxCall(
                    //系统设置
                    'channelSub/updateChannelSubMer',
                    tjData,
                    function(data) {
                        if (data.code == 1000) {

                            layer.msg('保存成功')
                            setTimeout(function() {
                                $('#quxiao').click()
                            }, 16);
                            parent.layui.table.reload('vip_cardList')

                        } else {
                            layer.msg(data.msg)

                        }
                    },
                    function(data) {
                        console.log('222')
                    }
                )
                return false;
            });

        });
    }
    </script>
</body>

</html>